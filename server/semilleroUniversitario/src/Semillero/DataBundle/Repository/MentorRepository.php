<?php

namespace Semillero\DataBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
* MentorRepository
*
* This class was generated by the Doctrine ORM. Add your own custom
* repository methods below.
*/
class MentorRepository extends EntityRepository
{
  public function recoverPass($numeroDocumento)
  {
    return $this->getEntityManager()
    ->createQuery("SELECT m.password FROM DataBundle:Mentor m WHERE m.numeroDocumento = :query")
    ->setParameter("query",$numeroDocumento)
    ->getResult();
  }

  //Metodo que lista todos los mentores, tambien es utilizado para cuando
  //Se realizan busquedas
  //@param $querySearch : busqueda a realizar
  public function getAllMentores($querySearch)
  {
    return $this->getEntityManager()
    ->createQuery("SELECT m FROM DataBundle:Mentor m JOIN m.tipoMentor tm JOIN m.tipoDocumento td WHERE
      (upper(m.nombre) like upper(:querySearch) OR upper(m.apellidos) like upper(:querySearch)
      OR upper(m.numeroDocumento) like upper(:querySearch) OR upper(m.numeroCelular)
      like upper(:querySearch) OR upper(tm.nombre) like upper(:querySearch)
      OR upper(td.nombre) like upper(:querySearch) OR CAST(YEAR(m.fechaNacimiento) as string) like :querySearch
      OR CAST(MONTH(m.fechaNacimiento) as string) like :querySearch
      OR CAST(DAY(m.fechaNacimiento) as string) like :querySearch
      OR CONCAT(CAST(DAY(m.fechaNacimiento) as string),'-',
      CAST(MONTH(m.fechaNacimiento) as string),'-',
      CAST(YEAR(m.fechaNacimiento) as string)) like :querySearch)")
    ->setParameter('querySearch','%'.$querySearch.'%');
  }

  //Metodo que retorna el id del mentor que esta asignado al grupo que ingresa por parametro
  public function getMentorAsignadoPorGrupo($idGrupo){
    return $this->getEntityManager()
    ->createQuery('SELECT m_g from DataBundle:Mentor_Grupos m_g WHERE m_g.grupo = :id and
    m_g.activo = TRUE')
    ->setParameter('id',$idGrupo)
    ->getOneOrNullResult();
  }

  // //Retorna todos los mentores
  public function findAll()
  {
    return $this->findBy(array(), array('nombre' => 'DESC'));
  }
}
